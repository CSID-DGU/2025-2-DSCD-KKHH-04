# ~/backend/sign/gemini_client.py
import os
from google import genai

# ğŸ”¹ API í‚¤ ì½ê¸° (í™˜ê²½ë³€ìˆ˜)
API_KEY = os.environ.get("GOOGLE_API_KEY")
if not API_KEY:
    raise RuntimeError("í™˜ê²½ë³€ìˆ˜ GOOGLE_API_KEYê°€ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ í™˜ê²½ë³€ìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.")

client = genai.Client(api_key=API_KEY)

# ğŸ”¹ GenAI í´ë¼ì´ì–¸íŠ¸
DEFAULT_MODEL = "gemini-2.5-flash"

# ğŸ”¹ íŒ€ì›ì´ ë§Œë“  SYSTEM PROMPTë§Œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
SYSTEM_PROMPT = """
ë‹¹ì‹ ì€ ë†ì¸ì˜ í•œêµ­ ìˆ˜ì–´ ë°œí™”ë¥¼ ì€í–‰ ì°½êµ¬ ì§ì›ì´ ì´í•´í•  ìˆ˜ ìˆëŠ” ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ ë¬¸ì¥ìœ¼ë¡œ ë°”ê¾¸ëŠ” ë„ìš°ë¯¸ì…ë‹ˆë‹¤.

[ì…ë ¥ í˜•ì‹]
- ì…ë ¥ì€ ìˆ˜ì–´ ì¸ì‹ ì‹œìŠ¤í…œì—ì„œ ì˜¨ ë‹¨ì–´ ë˜ëŠ” ê¸€ë¡œìŠ¤ë“¤ì˜ ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤.
- ì˜ˆ: ["ê³„ì¢Œ", "ë¹„ë°€ë²ˆí˜¸", "ê¹Œë¨¹ë‹¤", "ìƒˆë¡œ", "ì‹ ì²­í•˜ë‹¤", "ì›í•˜ë‹¤"]

[ì¶œë ¥ ê·œì¹™]
1. ì…ë ¥ ë‹¨ì–´ì˜ ì˜ë¯¸ë¥¼ ë³´ì¡´í•˜ë©° ìì—°ìŠ¤ëŸ¬ìš´ ì¡´ëŒ“ë§ í•œ ë¬¸ì¥ìœ¼ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤.
2. ì •ë³´ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ìƒëµí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
3. ì„¤ëª… ì—†ì´ ê²°ê³¼ ë¬¸ì¥ë§Œ í•œ ì¤„ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.
4. ì˜ë¬¸ë¬¸ì´ë¼ íŒë‹¨ë  ê²½ìš° ë¬¸ì¥ì„ "?"ë¡œ ë§ˆì¹©ë‹ˆë‹¤.

[ì˜ˆì‹œ]
ì…ë ¥: ["í†µì¥", "ê°œì„¤", "ì›í•˜ë‹¤"]
ì¶œë ¥: "í†µì¥ì„ ê°œì„¤í•˜ê³  ì‹¶ì–´ìš”."

ì…ë ¥: ['ì›”ê¸‰', 'ì´ì²´', 'ê³„ì¢Œ', 'ë³€ê²½í•˜ë‹¤']
ì¶œë ¥: 'ì›”ê¸‰ ì´ì²´ ê³„ì¢Œë¥¼ ë³€ê²½í•˜ê³  ì‹¶ì–´ìš”.'
""".strip()



def gloss_to_sentence_korean(tokens: list[str], model: str | None = None) -> str:
    if not tokens:
        return ""

    gloss_str = ", ".join(f'"{t}"' for t in tokens)  # ["a","b","c"] ìŠ¤íƒ€ì¼

    prompt = f"""
{SYSTEM_PROMPT}

[ì…ë ¥ ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸]
[{gloss_str}]

ìœ„ ë‹¨ì–´ë“¤ì„ ì‚¬ìš©í•´ ë†ì¸ì˜ ë°œí™” ì˜ë„ë¥¼ ë³´ì¡´í•œ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ ë¬¸ì¥ì„
ì¡´ëŒ“ë§ í•œ ë¬¸ì¥ìœ¼ë¡œë§Œ ì¶œë ¥í•˜ì‹­ì‹œì˜¤.
""".strip()

    resp = client.models.generate_content(
        model=DEFAULT_MODEL,
        contents=prompt,
    )

    text = getattr(resp, "text", "") or ""
    return text.strip()
